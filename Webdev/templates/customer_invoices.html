{% extends "base.html" %}
{% block title %}My Invoices{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto;">

    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="font-size: 1.75rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem;">
                <i class="fas fa-file-invoice" style="color: var(--primary);"></i> My Invoices
            </h1>
            <p style="color: var(--secondary); font-size: 0.95rem;">View and pay your invoices below.</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            {% if total_due > 0 %}
            <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1rem 1.5rem; border-radius: 12px; text-align: right; box-shadow: 0 4px 12px rgba(59,130,246,0.3);">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.85;">Total Outstanding</div>
                <div style="font-size: 1.75rem; font-weight: 700;">${{ "%.2f"|format(total_due) }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Status Filter -->
    <div class="content" style="margin-bottom: 1.5rem; padding: 1rem 1.5rem;">
        <form method="GET" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
            <span style="font-size: 0.875rem; font-weight: 600; color: var(--secondary);">Filter:</span>
            {% for value, label in [('all','All'), ('overdue','Overdue'), ('paid','Paid')] %}
            <a href="?status={{ value }}"
            style="padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-decoration: none; transition: all 0.2s;
                    {% if status_filter == value %}
                        background: var(--primary); color: white;
                    {% else %}
                        background: #f1f5f9; color: var(--secondary);
                    {% endif %}">
                {{ label }}
            </a>
            {% endfor %}
        </form>
    </div>

    <!-- Latest Invoices Table -->
    {% if invoices %}
    <div class="content" style="padding: 0; overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--light); border-bottom: 1px solid var(--border);">
            <h3 style="margin: 0; font-size: 1.1rem;">
                <i class="fas fa-clock"></i> Latest Invoices
            </h3>
            {% if all_invoices_count > 5 %}
            <a href="{{ url_for('customer_all_invoices_page') }}" class="btn" style="padding: 0.5rem 1rem; background: var(--primary); color: white;">
                <i class="fas fa-list"></i> View All Records ({{ all_invoices_count }})
            </a>
            {% endif %}
        </div>
        <table>
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th style="text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr style="{% if invoice.status == 'overdue' %}background: #fff8f8;{% endif %}">
                    <td>
                        <span style="font-weight: 700; color: var(--primary); font-family: monospace; font-size: 0.9rem;">
                            {{ invoice.invoice_number }}
                        </span>
                    </td>
                    <td>
                        {% if invoice.title %}
                            {{ invoice.title }}
                        {% else %}
                            <span style="color: #aaa; font-style: italic;">No title</span>
                        {% endif %}
                    </td>
                    <td style="color: var(--secondary); font-size: 0.875rem;">{{ invoice.date.strftime('%d %b %Y') }}</td>
                    <td style="font-size: 0.875rem; {% if invoice.status == 'overdue' %}color: var(--danger); font-weight: 600;{% else %}color: var(--secondary);{% endif %}">
                        {% if invoice.status == 'overdue' %}<i class="fas fa-exclamation-triangle" style="font-size:0.7rem; margin-right:4px;"></i>{% endif %}
                        {{ invoice.due_date.strftime('%d %b %Y') }}
                    </td>
                    <td style="font-weight: 700;">${{ "%.2f"|format(invoice.total_amount) }}</td>
                    <td><span class="status {{ invoice.status }}">{{ invoice.status }}</span></td>
                    <td style="text-align: center; white-space: nowrap;">
                        <a href="{{ url_for('customer_invoice_detail_page', invoice_id=invoice.id) }}"
                           class="btn" style="padding: 0.4rem 0.85rem; font-size: 0.8rem; margin-right: 6px; background: var(--primary); color: white;" title="View Invoice">
                            <i class="fas fa-eye"></i> View
                        </a>
                        
                        {% if invoice.status in ['sent', 'overdue'] %}
                        <span style="color: #aaa; font-size: 0.8rem; font-style: italic; margin-left: 5px;">
                            (Pay on view page)
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Summary Stats -->
<div class="row" style="margin-top: 1.5rem;">
    {% set ns = namespace(paid=0, overdue=0) %}
    {% for inv in invoices %}
        {% if inv.status == 'overdue' %}{% set ns.overdue = ns.overdue + inv.total_amount %}{% endif %}
        {% if inv.status == 'paid' %}{% set ns.paid = ns.paid + inv.total_amount %}{% endif %}
    {% endfor %}
    <div class="card col" style="text-align: center;">
        <h3>Overdue</h3>
        <div class="number" style="color: var(--danger);">${{ "%.2f"|format(ns.overdue) }}</div>
    </div>
    <div class="card col" style="text-align: center;">
        <h3>Paid</h3>
        <div class="number" style="color: var(--success);">${{ "%.2f"|format(ns.paid) }}</div>
    </div>
</div>

    {% else %}
    <div class="content" style="text-align: center; padding: 60px 40px; color: var(--secondary);">
        <i class="fas fa-file-invoice" style="font-size: 3.5rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
        <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">No invoices found</p>
        <p style="font-size: 0.9rem;">
            {% if status_filter != 'all' %}
                No <strong>{{ status_filter }}</strong> invoices. <a href="{{ url_for('customer_invoices_page') }}">View all</a>
            {% else %}
                You don't have any invoices yet. Contact your provider if you believe this is an error.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}